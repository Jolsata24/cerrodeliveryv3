<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Zona de Reparto - CerroDelivery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 500px; width: 100%; border-radius: 10px; border: 2px solid #333; }
        .instrucciones { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body class="bg-light p-4">

<div class="container">
    <h2 class="mb-3 text-primary"> Dibujar Zona de Reparto (Pasco)</h2>
    
    <div class="row">
        <div class="col-md-4">
            <div class="instrucciones shadow-sm">
                <h5>C贸mo usar:</h5>
                <ol>
                    <li>Haz clic en el mapa para marcar los puntos del borde de tu zona permitida.</li>
                    <li>Ve rodeando toda la zona segura (Yanacancha, San Juan, etc.).</li>
                    <li>Cierra el circuito intentando volver al inicio visualmente.</li>
                    <li>Copia el c贸digo generado abajo.</li>
                </ol>
                <button onclick="borrarUltimo()" class="btn btn-warning w-100 mb-2">Deshacer 煤ltimo punto</button>
                <button onclick="limpiarMapa()" class="btn btn-danger w-100">Borrar todo</button>
            </div>
            
            <div class="form-group">
                <label class="fw-bold">Copia esto en tu Checkout:</label>
                <textarea id="output" class="form-control" rows="10" readonly style="font-family: monospace; font-size: 12px;"></textarea>
                <button onclick="copiarCodigo()" class="btn btn-success w-100 mt-2">Copiar C贸digo</button>
            </div>
        </div>
        
        <div class="col-md-8">
            <div id="map"></div>
            <p class="text-muted mt-2 text-center small">Mapa centrado en Cerro de Pasco (-10.683, -76.256)</p>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Centrado en Cerro de Pasco (mismas coordenadas que tu checkout.php)
    var map = L.map('map').setView([-10.683, -76.256], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '漏 OpenStreetMap'
    }).addTo(map);

    // Arrays para guardar la l贸gica
    var coordenadas = [];
    var marcadores = [];
    var poligono = null;

    // 2. Evento al hacer clic en el mapa
    map.on('click', function(e) {
        var lat = parseFloat(e.latlng.lat.toFixed(5));
        var lng = parseFloat(e.latlng.lng.toFixed(5));

        // Agregar a la lista
        coordenadas.push([lat, lng]);

        // Dibujar marcador visual
        var marker = L.circleMarker([lat, lng], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 5
        }).addTo(map);
        marcadores.push(marker);

        dibujarPoligono();
        actualizarOutput();
    });

    function dibujarPoligono() {
        if (poligono) map.removeLayer(poligono);
        
        // Dibujamos el pol铆gono conectando los puntos
        if (coordenadas.length > 1) {
            poligono = L.polygon(coordenadas, {color: 'blue'}).addTo(map);
        }
    }

    function actualizarOutput() {
        var texto = "const zonaReparto = [\n";
        coordenadas.forEach(coord => {
            texto += `    [${coord[0]}, ${coord[1]}],\n`;
        });
        texto += "];";
        document.getElementById('output').value = texto;
    }

    function borrarUltimo() {
        if (coordenadas.length > 0) {
            coordenadas.pop();
            map.removeLayer(marcadores.pop());
            dibujarPoligono();
            actualizarOutput();
        }
    }

    function limpiarMapa() {
        coordenadas = [];
        marcadores.forEach(m => map.removeLayer(m));
        marcadores = [];
        if (poligono) map.removeLayer(poligono);
        poligono = null;
        actualizarOutput();
    }

    function copiarCodigo() {
        var copyText = document.getElementById("output");
        copyText.select();
        document.execCommand("copy");
        alert("隆C贸digo copiado! Ahora p茅galo en tu checkout.php");
    }
</script>

</body>
</html>